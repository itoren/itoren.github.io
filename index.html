<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>MyCall ‚Äî –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0071e3">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230071e3%22>üìû</text></svg>">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    :root { --face-blue: #0071e3; }
    body {
      background: linear-gradient(135deg, #e0e0e5, #d0d4db);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; height: 100vh; overflow: hidden;
    }
    .video-container {
      position: relative; width: 100%; height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    video {
      border-radius: 20px; background: #000; object-fit: cover;
    }
    #remoteVideo { 
        width: 100%; height: 100%; border-radius: 24px;
        opacity: 0; transition: opacity 0.3s;
    }
    #remoteVideo.active { opacity: 1; }
    
    #localVideo {
      position: absolute; bottom: 20px; right: 20px;
      width: 180px; height: 135px; border: 3px solid white;
      border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .controls {
      position: absolute; bottom: 5vh; display: flex; gap: 16px;
      z-index: 11;
    }
    .btn-circle {
      width: 64px; height: 64px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: none;
    }
    .btn-green { background: #30d158; color: white; }
    .btn-red { background: #ff3b30; color: white; }
    .btn-gray { background: #545458; color: white; }
    .btn-orange { background: #ff9500; color: white; }
    .setup-card {
      background: white; border-radius: 24px; padding: 28px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-width: 500px; width: 90%;
    }
    .logo {
      font-size: 2.2rem; font-weight: 700;
      background: linear-gradient(90deg, #0071e3, #5ac8fa);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .status-bar {
      position: absolute; top: 20px; background: rgba(0,0,0,0.6);
      color: white; padding: 8px 20px; border-radius: 50px;
      font-weight: 500; backdrop-filter: blur(8px);
      min-width: 150px; text-align: center;
    }
  </style>
</head>
<body>

  <div id="app">
    <!-- Init -->
    <div v-if="state === 'init'" class="video-container">
      <div class="text-center">
        <h2 class="logo mb-3">MyCall</h2>
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</p>
      </div>
    </div>

    <!-- Setup -->
    <div v-else-if="state === 'setup'" class="video-container">
      <div class="setup-card">
        <h2 class="logo text-center mb-3">MyCall</h2>
        <p class="text-center text-muted mb-4">–ù–∞—á–Ω–∏—Ç–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞ —Å–µ–∫—É–Ω–¥—ã</p>

        <div class="mb-3">
          <input v-model="username" @keyup.enter="createOrJoinRoom"
            class="form-control form-control-lg" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)" maxlength="20">
        </div>

        <button @click="createOrJoinRoom" :disabled="!username.trim()"
          class="btn btn-primary btn-lg w-100 mb-3">
          <i class="bi bi-plus-circle me-2"></i> {{ roomFromUrl ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å/–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è' }}
        </button>

        <div v-if="roomFromUrl" class="mt-3 p-3 bg-light rounded-3">
          <p class="mb-1"><small>–ö–æ–º–Ω–∞—Ç–∞:</small></p>
          <p class="fw-bold text-primary mb-2">{{ roomFromUrl }}</p>
          <button @click="handleJoinFromUrl" :disabled="!username.trim()" class="btn btn-success w-100">
            <i class="bi bi-telephone-inbound me-2"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
          </button>
        </div>

        <div v-if="roomLink && !roomFromUrl" class="mt-4">
          <p class="small text-muted mb-2">–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</p>
          <div class="input-group">
            <input :value="roomLink" class="form-control" readonly>
            <button class="btn btn-outline-primary" @click="copyLink">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <p v-if="copied" class="text-success mt-2 small">
            <i class="bi bi-check-circle-fill me-1"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
          </p>
        </div>
      </div>
    </div>

    <!-- Waiting -->
    <div v-else-if="state === 'waiting'" class="video-container">
      <div class="status-bar bg-warning text-dark">
        <i class="bi bi-clock me-2"></i> –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞‚Ä¶
      </div>
      <h3 class="logo text-white mb-3">MyCall</h3>
      <button @click="hangup" class="btn btn-outline-light btn-sm mt-4">
        <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
      </button>
    </div>

    <!-- Incoming -->
    <div v-else-if="state === 'incoming'" class="video-container">
      <div class="status-bar">
        <i class="bi bi-telephone-incoming me-2"></i> –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
      </div>
      <div class="text-center text-white mt-4">
        <h4 class="logo">{{ remoteUsername || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' }}</h4>
        <div class="mt-4 d-flex gap-3 justify-content-center">
          <button @click="declineCall" class="btn-circle btn-red">
            <i class="bi bi-telephone-x"></i>
          </button>
          <button @click="acceptCall" class="btn-circle btn-green">
            <i class="bi bi-telephone"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Call -->
    <div v-else-if="state === 'call'" class="video-container">
      <div class="status-bar" :class="isScreenSharing ? 'bg-orange' : 'bg-success'">
        <i :class="isScreenSharing ? 'bi bi-display' : 'bi bi-circle-fill me-2'"></i>
        <span>{{ isScreenSharing ? '–≠–∫—Ä–∞–Ω' : remoteUsername || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫' }}</span>
      </div>

      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay playsinline muted></video>

      <div class="controls">
        <button @click="toggleMute" class="btn-circle btn-gray" :class="{ 'btn-outline-danger': isMuted }">
          <i :class="isMuted ? 'bi bi-mic-mute-fill' : 'bi bi-mic-fill'"></i>
        </button>
        <button @click="toggleVideo" class="btn-circle btn-gray" :class="{ 'btn-outline-danger': isVideoOff }">
          <i :class="isVideoOff ? 'bi bi-camera-video-off-fill' : 'bi bi-camera-video-fill'"></i>
        </button>
        <button v-if="!isMobile" @click="toggleScreenShare" class="btn-circle" 
                :class="isScreenSharing ? 'btn-orange' : 'btn-gray'">
          <i class="bi bi-display"></i>
        </button>
        <button @click="hangup" class="btn-circle btn-red">
          <i class="bi bi-telephone-x"></i>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getDatabase, ref as dbRef, child, get, onValue, off, set, push, remove
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDm0pktTEXSg2NYNKa5QYyFIaOmvUpcTlU",
      authDomain: "itoren-294cd.firebaseapp.com",
      databaseURL: "https://itoren-294cd-default-rtdb.firebaseio.com",
      projectId: "itoren-294cd",
      storageBucket: "itoren-294cd.firebasestorage.app",
      messagingSenderId: "1062865810662",
      appId: "1:1062865810662:web:82633754d15fa6a741f727"
    };

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);
    } catch (e) {}

    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
      setup() {
        const state = ref('init');
        const username = ref(localStorage.getItem('mycall_username') || '');
        const roomID = ref('');
        const remoteUsername = ref('');
        const roomLink = ref('');
        const copied = ref(false);
        const isMuted = ref(false);
        const isVideoOff = ref(false);
        const isScreenSharing = ref(false);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = ref(urlParams.get('room'));

        let localStream = null;
        let screenStream = null;
        let remoteStream = null;
        let pc = null;
        let roomRef = null;
        let offerKey = null;
        let firebaseListeners = [];

        const iceServers = [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun.relay.metered.ca:80" },
          { urls: "turn:global.relay.metered.ca:80", username: "8a7442639411ebfc09636a1a", credential: "qbFGq2h7QIlueoIk" },
        ];

        // –ù–∞–¥—ë–∂–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ
        function setVideoSrc(videoId, stream) {
          if (!stream) return;
          let attempts = 0;
          const trySet = () => {
            const video = document.getElementById(videoId);
            if (video) {
              video.srcObject = stream;
              video.play().catch(() => {
                const unlock = () => { video.play().catch(() => {}); video.removeEventListener('click', unlock); };
                video.addEventListener('click', unlock);
              });
              if (videoId === 'remoteVideo') video.classList.add('active');
            } else if (attempts < 20) {
              attempts++;
              setTimeout(trySet, 50);
            }
          };
          trySet();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞
        async function getMedia() {
          if (localStream) localStream.getTracks().forEach(t => t.stop());
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { width: { ideal: 1280 }, height: { ideal: 720 } },
              audio: true
            });
            localStream = stream;
            return stream;
          } catch (e) {
            let msg = '–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: ';
            if (e.name === 'NotAllowedError') msg += '—Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
            else if (e.name === 'NotFoundError') msg += '—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
            else msg += '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
            alert(msg);
            throw e;
          }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
        function createPeerConnection() {
          pc = new RTCPeerConnection({ iceServers });

          if (localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          }

          pc.ontrack = (event) => {
            if (!remoteStream && event.streams[0]) {
              remoteStream = event.streams[0];
            }
          };

          pc.onicecandidate = async (event) => {
            if (event.candidate && roomRef) {
              await push(child(roomRef, 'iceCandidates'), { candidate: event.candidate.toJSON() });
            }
          };

          pc.onconnectionstatechange = () => {
            if (['failed', 'disconnected', 'closed'].includes(pc.connectionState)) {
              if (state.value === 'call') hangup();
            }
          };
        }

        // –°–∏–≥–Ω–∞–ª–∏–Ω–≥
        async function createOffer() {
          const offer = await pc.createOffer({ offerToReceiveVideo: true, offerToReceiveAudio: true });
          await pc.setLocalDescription(offer);

          const offerData = {
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
            username: username.value.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            timestamp: Date.now()
          };

          const offerRef = await push(child(roomRef, 'offers'), offerData);
          offerKey = offerRef.key;
        }

        async function createOrJoinRoom() {
          const cleanName = username.value.trim();
          if (!cleanName) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');

          localStorage.setItem('mycall_username', cleanName);

          if (roomFromUrl.value) {
            roomID.value = roomFromUrl.value;
            roomLink.value = `${window.location.origin}?room=${roomFromUrl.value}`;
            state.value = 'incoming';
            roomRef = dbRef(db, `rooms/${roomID.value}`);
            listenForOffers();
          } else {
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            roomID.value = id;
            roomLink.value = `${window.location.origin}?room=${id}`;
            roomRef = dbRef(db, `rooms/${id}`);

            try {
              await getMedia();
              createPeerConnection();
              await createOffer();
              state.value = 'waiting';
              listenForAnswer();
            } catch (e) {
              hangup();
            }
          }
        }

        function handleJoinFromUrl() {
          const cleanName = username.value.trim();
          if (!cleanName) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
          localStorage.setItem('mycall_username', cleanName);
          roomID.value = roomFromUrl.value;
          roomLink.value = `${window.location.origin}?room=${roomFromUrl.value}`;
          state.value = 'incoming';
          roomRef = dbRef(db, `rooms/${roomID.value}`);
          listenForOffers();
        }

        function listenForOffers() {
          if (!roomRef || state.value !== 'incoming') return;
          const offersRef = child(roomRef, 'offers');
          const listener = onValue(offersRef, (snapshot) => {
            if (snapshot.exists()) {
              const data = Object.values(snapshot.val())[0];
              if (data?.username) remoteUsername.value = data.username;
            }
          });
          firebaseListeners.push({ ref: offersRef, fn: listener });
        }

        function listenForAnswer() {
          if (!roomRef || !offerKey) return;
          const answerRef = child(roomRef, `answers/${offerKey}`);
          const listener = onValue(answerRef, async (snapshot) => {
            if (snapshot.exists() && pc) {
              const answerData = snapshot.val();
              if (answerData?.sdp && answerData.type === 'answer') {
                try {
                  await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answerData.sdp }));
                  state.value = 'call';
                } catch (e) {
                  hangup();
                }
              }
            }
          });
          firebaseListeners.push({ ref: answerRef, fn: listener });
        }

        async function acceptCall() {
          try {
            await getMedia();
            createPeerConnection();

            let offerData = null;
            for (let i = 0; i < 10; i++) {
              const offersSnap = await get(child(roomRef, 'offers'));
              const offers = offersSnap.val();
              if (offers) {
                offerKey = Object.keys(offers)[0];
                offerData = offers[offerKey];
                break;
              }
              await new Promise(r => setTimeout(r, 500));
            }

            if (!offerData) throw new Error();
            if (typeof offerData.sdp !== 'string' || offerData.type?.toLowerCase() !== 'offer') throw new Error();

            remoteUsername.value = offerData.username?.trim() || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';

            await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: offerData.sdp }));

            const answer = await pc.createAnswer({ offerToReceiveVideo: true, offerToReceiveAudio: true });
            await pc.setLocalDescription(answer);

            await set(child(roomRef, `answers/${offerKey}`), {
              sdp: pc.localDescription.sdp,
              type: pc.localDescription.type,
              username: username.value.trim() || '–Ø'
            });

            state.value = 'call';

          } catch (e) {
            hangup();
          }
        }

        function listenForCandidates() {
          if (!roomRef || !pc) return;
          const iceRef = child(roomRef, 'iceCandidates');
          const listener = onValue(iceRef, (snapshot) => {
            if (!snapshot.exists()) return;
            snapshot.forEach((childSnap) => {
              const data = childSnap.val();
              if (data?.candidate) {
                pc.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => {});
              }
            });
          });
          firebaseListeners.push({ ref: iceRef, fn: listener });
        }

        // üîπ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä–∞/—ç–∫—Ä–∞–Ω
        async function toggleScreenShare() {
          if (isScreenSharing.value) {
            // –í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞–º–µ—Ä–µ
            if (screenStream) {
              screenStream.getTracks().forEach(t => t.stop());
              screenStream = null;
            }
            isScreenSharing.value = false;

            const cameraTrack = localStream?.getVideoTracks()[0];
            const videoSender = pc?.getSenders().find(s => s.track?.kind === 'video');
            if (videoSender && cameraTrack) {
              videoSender.replaceTrack(cameraTrack);
            }
            if (localStream) setVideoSrc('localVideo', localStream);
          } else {
            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
            try {
              const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "motion", width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
              });
              screenStream = stream;
              isScreenSharing.value = true;

              const screenTrack = screenStream.getVideoTracks()[0];
              const videoSender = pc?.getSenders().find(s => s.track?.kind === 'video');
              
              if (videoSender && screenTrack) {
                videoSender.replaceTrack(screenTrack);
              } else if (pc) {
                pc.addTrack(screenTrack, screenStream);
              }
              setVideoSrc('localVideo', screenStream);
            } catch (e) {
              if (e.name !== 'NotAllowedError') {
                isScreenSharing.value = false;
              }
            }
          }
        }

        function hangup() {
          [localStream, screenStream, remoteStream].forEach(s => {
            if (s) s.getTracks().forEach(t => t.stop());
          });
          if (pc) pc.close();

          firebaseListeners.forEach(({ ref, fn }) => off(ref, fn));
          firebaseListeners = [];

          if (roomRef) {
            set(child(roomRef, 'hangup'), true).catch(() => {});
            setTimeout(() => { if (roomRef) remove(roomRef).catch(() => {}); }, 3000);
          }

          pc = localStream = screenStream = remoteStream = roomRef = null;
          offerKey = null;
          roomID.value = '';
          remoteUsername.value = '';
          isScreenSharing.value = false;
          isMuted.value = false;
          isVideoOff.value = false;
          window.history.replaceState({}, '', window.location.pathname);
          state.value = 'setup';
        }

        function toggleMute() {
          const track = localStream?.getAudioTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isMuted.value = !track.enabled;
          }
        }

        function toggleVideo() {
          const track = localStream?.getVideoTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isVideoOff.value = !track.enabled;
          }
        }

        function copyLink() {
          if (roomLink.value) {
            navigator.clipboard.writeText(roomLink.value)
              .then(() => { copied.value = true; setTimeout(() => copied.value = false, 2000); })
              .catch(() => {});
          }
        }

        // üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ 'call'
        watch(state, (newState) => {
          if (newState === 'call') {
            if (localStream) setVideoSrc('localVideo', localStream);
            if (remoteStream) setVideoSrc('remoteVideo', remoteStream);
            listenForCandidates();
          }
        });

        onMounted(() => {
          if (!window.RTCPeerConnection || !db) {
            alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
          }
          state.value = 'setup';
        });

        return {
          state, username, roomID, remoteUsername, roomLink, copied,
          isMuted, isVideoOff, isScreenSharing, isMobile,
          roomFromUrl,
          createOrJoinRoom, handleJoinFromUrl, acceptCall, declineCall: hangup,
          toggleMute, toggleVideo, toggleScreenShare, hangup, copyLink
        };
      }
    }).mount('#app');

    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
