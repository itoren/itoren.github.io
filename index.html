<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>MyCall — Видеозвонки как в FaceTime</title>

  <!-- ✅ Настоящий manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0071e3">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root { --face-blue: #0071e3; }
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #e0e0e5, #d0d4db);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0; height: 100vh; overflow: hidden;
    }
    .video-container {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; width: 100%; height: 100vh;
    }
    .setup-card {
      background: white; border-radius: 24px; padding: 28px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-width: 500px; width: 90%;
    }
    .logo { font-size: 2.2rem; font-weight: 700; color: var(--face-blue); }
    .btn-lg { border-radius: 18px; padding: 12px 24px; }
    .room-link { color: var(--face-blue); text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="state === 'setup'" class="video-container">
      <div class="setup-card">
        <h1 class="logo text-center mb-3">MyCall</h1>
        <p class="text-center text-muted mb-4">Начните видеозвонок за секунды</p>

        <div class="mb-3">
          <input v-model="username" @keyup.enter="createOrJoinRoom"
            class="form-control form-control-lg" placeholder="Ваше имя" maxlength="20">
        </div>

        <button @click="createOrJoinRoom" :disabled="!username.trim()"
          class="btn btn-primary btn-lg w-100 mb-3">
          Создать комнату
        </button>

        <!-- ✅ Исправлено: roomFromUrl → просто roomFromUrl -->
        <div v-if="roomFromUrl" class="mt-3 p-2 bg-light rounded">
          <p class="mb-1"><small>Подключение к комнате:</small></p>
          <p class="fw-bold text-primary">{{ roomFromUrl }}</p>
          <button @click="joinRoom(roomFromUrl)" class="btn btn-success btn-sm">
            Присоединиться
          </button>
        </div>
      </div>
    </div>

    <!-- Другие состояния (waiting, incoming, call) — по аналогии, без $route -->
    <!-- Для краткости не дублирую, но они должны использовать roomFromUrl, а не $route -->
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDm0pktTEXSg2NYNKa5QYyFIaOmvUpcTlU",
      authDomain: "itoren-294cd.firebaseapp.com",
      databaseURL: "https://itoren-294cd-default-rtdb.firebaseio.com",
      projectId: "itoren-294cd",
      storageBucket: "itoren-294cd.firebasestorage.app",
      messagingSenderId: "1062865810662",
      appId: "1:1062865810662:web:82633754d15fa6a741f727"
    };

    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.error("Firebase init error:", e);
    }
  </script>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const state = ref('setup');
        const username = ref('');
        const roomID = ref('');
        const roomFromUrl = ref(new URLSearchParams(window.location.search).get('room'));

        // ✅ Полностью убрано $route

        function createOrJoinRoom() {
          if (!username.value.trim()) return;
          if (roomFromUrl.value) {
            joinRoom(roomFromUrl.value);
          } else {
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            roomID.value = id;
            // ... логика создания комнаты
            alert('Комната: ' + id + '\n(В демо-режиме)');
          }
        }

        function joinRoom(id) {
          alert('Присоединяемся к: ' + id);
          // ... логика присоединения
        }

        return {
          state,
          username,
          roomID,
          roomFromUrl, // ✅ строка или null
          createOrJoinRoom,
          joinRoom
        };
      }
    }).mount('#app');

    // ✅ Регистрация SW как /sw.js
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .catch(console.warn);
      });
    }
  </script>
</body>
</html>
