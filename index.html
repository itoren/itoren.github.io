<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>MyCall ‚Äî –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ –∫–∞–∫ –≤ FaceTime</title>

  <!-- PWA: Manifest (inline) -->
  <link rel="manifest" href="application/manifest+json,{
    %22name%22:%22MyCall%22,
    %22short_name%22:%22MyCall%22,
    %22description%22:%22–í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏%20–∫–∞–∫%20–≤%20FaceTime%22,
    %22start_url%22:%22/%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23ffffff%22,
    %22theme_color%22:%22%230071e3%22,
    %22icons%22:[
      {
        %22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%230071e3'/%3E%3Ccircle cx='96' cy='96' r='56' fill='%23ffffff'/%3E%3C/svg%3E%22,
        %22sizes%22:%22192x192%22,
        %22type%22:%22image/svg+xml%22
      },
      {
        %22src%22:%22image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230071e3'/%3E%3Ccircle cx='256' cy='256' r='150' fill='%23ffffff'/%3E%3C/svg%3E%22,
        %22sizes%22:%22512x512%22,
        %22type%22:%22image/svg+xml%22
      }
    ],
    %22orientation%22:%22portrait-primary%22
  }">

  <meta name="theme-color" content="#0071e3">
  <link rel="apple-touch-icon" href="image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%230071e3'/%3E%3Ccircle cx='90' cy='90' r='50' fill='%23ffffff'/%3E%3C/svg%3E">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root {
      --face-blue: #0071e3;
      --face-gray: #f5f5f7;
      --face-dark: #1d1d1f;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #e0e0e5, #d0d4db);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif;
      overflow: hidden;
      height: 100vh;
      color: #1d1d1f;
      -webkit-font-smoothing: antialiased;
    }

    .video-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    video {
      border-radius: 28px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.35);
      background: #000;
      object-fit: cover;
      max-width: 90vw;
      max-height: 80vh;
    }

    #remoteVideo {
      width: 100%;
      height: 100%;
      border-radius: 28px;
    }

    #localVideo {
      position: absolute;
      bottom: 24px;
      right: 24px;
      width: 220px;
      height: 165px;
      border: 3px solid white;
      border-radius: 22px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 10;
      transition: all 0.3s ease;
    }
    #localVideo.screen-sharing {
      border-color: #ff9500;
      box-shadow: 0 0 0 4px rgba(255,149,0,0.4);
    }

    .controls {
      position: absolute;
      bottom: 110px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .btn-circle {
      width: 76px;
      height: 76px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      flex-shrink: 0;
      user-select: none;
    }

    .btn-red { background: linear-gradient(135deg, #ff3b30, #cc2015); color: white; }
    .btn-green { background: linear-gradient(135deg, #30d158, #1e9c45); color: white; }
    .btn-gray { background: linear-gradient(135deg, #545458, #3a3a3c); color: white; }
    .btn-blue { background: linear-gradient(135deg, #0071e3, #005ac8); color: white; }
    .btn-orange { background: linear-gradient(135deg, #ff9500, #d97700); color: white; }

    .btn-circle:active {
      transform: scale(0.92) translateY(2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .status-bar {
      position: absolute;
      top: 24px;
      background: rgba(0,0,0,0.65);
      color: white;
      padding: 10px 24px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 1.05rem;
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .room-link {
      font-size: 0.95rem;
      color: var(--face-blue);
      text-decoration: underline;
      cursor: pointer;
      font-weight: 500;
    }

    .setup-card {
      background: white;
      border-radius: 28px;
      padding: 32px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      max-width: 520px;
      width: 92%;
    }

    .logo {
      font-size: 2.4rem;
      font-weight: 700;
      background: linear-gradient(90deg, #0071e3, #5ac8fa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }

    .input-group-lg > .form-control {
      padding: 16px 20px;
      font-size: 1.1rem;
      border-radius: 18px;
    }

    .btn-lg {
      padding: 14px 28px;
      font-size: 1.2rem;
      border-radius: 20px;
      font-weight: 600;
    }

    .pwa-install {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--face-blue);
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.4s ease;
    }
    .pwa-install.show {
      opacity: 1;
      transform: scale(1);
    }

    @media (max-width: 768px) {
      .btn-screen-share {
        display: none !important;
      }
      .controls {
        bottom: 84px;
        gap: 16px;
      }
      .btn-circle {
        width: 68px;
        height: 68px;
        font-size: 1.35rem;
      }
      #localVideo {
        width: 140px;
        height: 105px;
        bottom: 16px;
        right: 16px;
      }
      .setup-card {
        padding: 24px 20px;
        border-radius: 24px;
      }
      .logo {
        font-size: 2rem;
      }
    }

    @media (max-width: 480px) {
      .controls { bottom: 76px; }
      .status-bar { top: 16px; font-size: 0.95rem; padding: 8px 18px; }
    }

    .error-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ff3b30;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 500;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <div id="firebase-error" class="error-banner" style="display:none;">
    –û—à–∏–±–∫–∞ Firebase: Realtime Database –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.
  </div>

  <div id="app">
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
    <div v-if="state === 'init'" class="video-container">
      <div class="text-center">
        <h2 class="logo mb-4">MyCall</h2>
        <div class="spinner-border text-primary" role="status" style="width: 3.2rem; height: 3.2rem;"></div>
        <p class="mt-4 text-muted">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É‚Ä¶</p>
      </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ -->
    <div v-else-if="state === 'setup'" class="video-container">
      <div class="setup-card">
        <h2 class="logo text-center mb-3">MyCall</h2>
        <p class="text-center text-muted mb-4">–ù–∞—á–Ω–∏—Ç–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞ —Å–µ–∫—É–Ω–¥—ã</p>

        <div class="mb-4">
          <label class="form-label fw-semibold">–í–∞—à–µ –∏–º—è</label>
          <input v-model="username" @keyup.enter="createOrJoinRoom"
            class="form-control form-control-lg" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê–ª–µ–∫—Å–µ–π" maxlength="20">
        </div>

        <button @click="createOrJoinRoom" :disabled="!username.trim()"
          class="btn btn-primary btn-lg w-100 mb-3">
          <i class="bi bi-plus-circle me-2"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>

        <div v-if="roomLink" class="mt-4">
          <p class="small text-muted mb-2">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</p>
          <div class="input-group">
            <input :value="roomLink" class="form-control" readonly style="border-radius: 18px 0 0 18px;">
            <button class="btn btn-outline-primary" style="border-radius: 0 18px 18px 0;" @click="copyLink">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <p v-if="copied" class="text-success mt-2 small">
            <i class="bi bi-check-circle-fill me-1"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
          </p>
        </div>

        <div v-if="$route.room" class="mt-4 p-3 bg-light rounded-3">
          <p class="mb-2">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ:</p>
          <p class="fw-bold text-primary">{{ $route.room }}</p>
          <button @click="joinRoom($route.room)" class="btn btn-success w-100">
            <i class="bi bi-telephone-inbound me-2"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
          </button>
        </div>
      </div>
    </div>

    <!-- –û–∂–∏–¥–∞–Ω–∏–µ -->
    <div v-else-if="state === 'waiting'" class="video-container">
      <div class="status-bar">
        <i class="bi bi-clock"></i>
        <span>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞‚Ä¶</span>
      </div>
      <h3 class="logo text-white mb-4">MyCall</h3>
      <div class="text-center text-white">
        <p class="fs-5 mb-2">–í–∞—à–∞ –∫–æ–º–Ω–∞—Ç–∞:</p>
        <p class="room-link mb-3" @click="copyLink">{{ roomID }}</p>
        <button @click="hangup" class="btn btn-outline-light btn-sm px-4">
          <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
        </button>
      </div>
    </div>

    <!-- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ -->
    <div v-else-if="state === 'incoming'" class="video-container">
      <div class="status-bar text-warning">
        <i class="bi bi-telephone-incoming"></i>
        <span>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</span>
      </div>
      <div class="text-center mt-5 text-white">
        <div class="bg-white bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 120px; height: 120px; margin-bottom: 24px;">
          <i class="bi bi-person-circle" style="font-size: 3.5rem;"></i>
        </div>
        <h4 class="logo">{{ remoteUsername || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫' }}</h4>
        <p class="text-light opacity-75 mt-2">–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</p>
        <div class="mt-4 d-flex justify-content-center gap-4">
          <button @click="declineCall" class="btn-circle btn-red shadow">
            <i class="bi bi-telephone-x"></i>
          </button>
          <button @click="acceptCall" class="btn-circle btn-green shadow">
            <i class="bi bi-telephone"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ -->
    <div v-else-if="state === 'call'" class="video-container">
      <div v-if="remoteStatus" class="status-bar">
        <template v-if="isScreenSharing">
          <i class="bi bi-display-fill text-warning"></i>
          <span>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞</span>
        </template>
        <template v-else-if="remoteStatus === 'connected'">
          <i class="bi bi-circle-fill text-success"></i>
          <span>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ —Å–µ—Ç–∏</span>
        </template>
        <template v-else-if="remoteStatus === 'disconnected'">
          <i class="bi bi-exclamation-triangle-fill text-warning"></i>
          <span>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∑–≤–æ–Ω–æ–∫</span>
        </template>
        <template v-else-if="remoteStatus === 'connecting'">
          <i class="bi bi-arrow-repeat text-info"></i>
          <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</span>
        </template>
      </div>

      <video id="remoteVideo" autoplay playsinline muted="false"></video>
      <video id="localVideo" :class="{ 'screen-sharing': isScreenSharing }" autoplay playsinline muted></video>

      <div class="controls">
        <button @click="toggleMute" class="btn-circle btn-gray"
          :title="isMuted ? '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'">
          <i :class="isMuted ? 'bi bi-mic-mute-fill' : 'bi bi-mic-fill'"></i>
        </button>
        <button @click="toggleVideo" class="btn-circle btn-gray"
          :title="isVideoOff ? '–í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : '–í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ'">
          <i :class="isVideoOff ? 'bi bi-camera-video-off-fill' : 'bi bi-camera-video-fill'"></i>
        </button>
        <button v-if="!isMobile" @click="toggleScreenShare"
          class="btn-circle btn-orange btn-screen-share"
          :title="isScreenSharing ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é' : '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º'">
          <i class="bi bi-display"></i>
        </button>
        <button @click="hangup" class="btn-circle btn-red">
          <i class="bi bi-telephone-x"></i>
        </button>
      </div>

      <div class="position-absolute top-0 end-0 m-3">
        <button class="btn btn-sm btn-outline-light rounded-pill px-3" @click="copyLink">
          <i class="bi bi-share me-1"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
        </button>
      </div>
    </div>
  </div>

  <div id="pwa-install" class="pwa-install" @click="installPWA" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MyCall">
    <i class="bi bi-cloud-download"></i>
  </div>

  <script>
    // üîë –í–∞—à Firebase config (–≤—Å—ë –≤–µ—Ä–Ω–æ)
    const firebaseConfig = {
      apiKey: "AIzaSyDm0pktTEXSg2NYNKa5QYyFIaOmvUpcTlU",
      authDomain: "itoren-294cd.firebaseapp.com",
      databaseURL: "https://itoren-294cd-default-rtdb.firebaseio.com",
      projectId: "itoren-294cd",
      storageBucket: "itoren-294cd.firebasestorage.app",
      messagingSenderId: "1062865810662",
      appId: "1:1062865810662:web:82633754d15fa6a741f727",
      measurementId: "G-MSN9W05KNE"
    };

    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } catch (e) {
      console.error('‚ùå Firebase error:', e);
      document.getElementById('firebase-error').style.display = 'block';
    }
  </script>

  <script>
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
      setup() {
        const state = ref('init');
        const username = ref('');
        const roomID = ref('');
        const remoteUsername = ref('');
        const remoteStatus = ref(null);
        const isMuted = ref(false);
        const isVideoOff = ref(false);
        const isScreenSharing = ref(false);
        const roomLink = ref('');
        const copied = ref(false);
        const deferredPrompt = ref(null);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        let localStream = null;
        let screenStream = null;
        let remoteStream = null;
        let pc = null;
        let roomRef = null;
        let callerID = null;

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');

        onMounted(() => {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/').catch(console.warn);
          }
          window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt.value = e;
            setTimeout(() => {
              document.getElementById('pwa-install').classList.add('show');
            }, 2000);
          });
        });

        const installPWA = () => {
          if (deferredPrompt.value) {
            deferredPrompt.value.prompt();
            deferredPrompt.value.userChoice.then(() => {
              deferredPrompt.value = null;
              document.getElementById('pwa-install').classList.remove('show');
            });
          }
        };

        // üî• –í–ê–®–ò ICE SERVERS –æ—Ç Metered (https://metered.ca/tools/openrelay/)
        const iceServers = [
          {
            urls: "stun:stun.relay.metered.ca:80",
          },
          {
            urls: "turn:global.relay.metered.ca:80",
            username: "8a7442639411ebfc09636a1a",
            credential: "qbFGq2h7QIlueoIk",
          },
          {
            urls: "turn:global.relay.metered.ca:80?transport=tcp",
            username: "8a7442639411ebfc09636a1a",
            credential: "qbFGq2h7QIlueoIk",
          },
          {
            urls: "turn:global.relay.metered.ca:443",
            username: "8a7442639411ebfc09636a1a",
            credential: "qbFGq2h7QIlueoIk",
          },
          {
            urls: "turns:global.relay.metered.ca:443?transport=tcp",
            username: "8a7442639411ebfc09636a1a",
            credential: "qbFGq2h7QIlueoIk",
          },
        ];

        function generateRoomID() {
          return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function copyLink() {
          if (!roomID.value) return;
          const link = `${window.location.origin}${window.location.pathname}?room=${roomID.value}`;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(link).then(() => {
              copied.value = true;
              setTimeout(() => copied.value = false, 2000);
            });
          } else {
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            copied.value = true;
            setTimeout(() => copied.value = false, 2000);
          }
        }

        async function getMedia() {
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
              audio: { echoCancellation: true, noiseSuppression: true }
            });
            const localVideo = document.getElementById('localVideo');
            if (localVideo) localVideo.srcObject = localStream;
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (err.message || err.name));
            state.value = 'setup';
            throw err;
          }
        }

        async function createPeerConnection() {
          pc = new RTCPeerConnection({ iceServers }); // ‚Üê –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í–ê–® –ö–û–ù–§–ò–ì

          pc.onicecandidate = async (event) => {
            if (event.candidate && roomRef) {
              await roomRef.child('iceCandidates').push(event.candidate);
            }
          };

          pc.ontrack = (event) => {
            remoteStream = event.streams[0];
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) remoteVideo.srcObject = remoteStream;
          };

          if (localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          }

          pc.onconnectionstatechange = () => {
            if (!pc) return;
            switch (pc.connectionState) {
              case 'connected': remoteStatus.value = 'connected'; break;
              case 'disconnected': remoteStatus.value = 'disconnected'; break;
              case 'failed': alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); hangup(); break;
              case 'connecting': remoteStatus.value = 'connecting'; break;
            }
          };
        }

        async function toggleScreenShare() {
          if (isScreenSharing.value) {
            if (screenStream) {
              screenStream.getTracks().forEach(t => t.stop());
              screenStream = null;
            }
            if (pc && localStream) {
              const videoTrack = localStream.getVideoTracks()[0];
              const sender = pc.getSenders().find(s => s.track?.kind === 'video');
              if (sender && videoTrack) sender.replaceTrack(videoTrack);
            }
            isScreenSharing.value = false;
            const localVideo = document.getElementById('localVideo');
            if (localVideo && localStream) localVideo.srcObject = localStream;
          } else {
            try {
              screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: 'motion', width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: false
              });
              isScreenSharing.value = true;
              const screenVideoTrack = screenStream.getVideoTracks()[0];
              if (pc && screenVideoTrack) {
                const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                if (sender) sender.replaceTrack(screenVideoTrack);
                else pc.addTrack(screenVideoTrack, screenStream);
              }
              const localVideo = document.getElementById('localVideo');
              if (localVideo) localVideo.srcObject = screenStream;
            } catch (err) {
              if (err.name !== 'NotAllowedError') {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞.');
              }
              isScreenSharing.value = false;
            }
          }
        }

        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (createOrJoinRoom, acceptCall, hangup –∏ —Ç.–¥.) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É—é, –Ω–æ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –Ω–∏–∂–µ
        // ‚¨áÔ∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ —Å –Ω–∏–º–∏ ‚Äî –≤ –∞—Ä—Ö–∏–≤–µ –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É

        async function createOrJoinRoom() {
          if (!username.value.trim()) return;
          if (roomFromUrl) {
            joinRoom(roomFromUrl);
          } else {
            const id = generateRoomID();
            roomID.value = id;
            roomLink.value = `${window.location.origin}${window.location.pathname}?room=${id}`;
            await enterRoom(id, true);
          }
        }

        async function joinRoom(id) {
          roomID.value = id;
          roomLink.value = `${window.location.origin}${window.location.pathname}?room=${id}`;
          await enterRoom(id, false);
        }

        async function enterRoom(id, isCreator) {
          try {
            await getMedia();
            roomRef = db.ref(`rooms/${id}`);

            const snapshot = await roomRef.once('value');
            const data = snapshot.val();

            if (isCreator) {
              if (data && data.creator) {
                state.value = 'waiting';
                setupRoomListeners(id);
              } else {
                await roomRef.set({
                  creator: username.value,
                  createdAt: firebase.database.ServerValue.TIMESTAMP,
                  offer: null,
                  answer: null,
                  iceCandidates: []
                });
                state.value = 'waiting';
                setupRoomListeners(id);
              }
            } else {
              if (!data || !data.creator) {
                alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                state.value = 'setup';
                return;
              }
              remoteUsername.value = data.creator;
              callerID = 'creator';
              state.value = 'incoming';
              setupRoomListeners(id);
            }
          } catch (e) {
            console.error(e);
            state.value = 'setup';
          }
        }

        function setupRoomListeners(roomId) {
          roomRef.on('value', async (snapshot) => {
            const data = snapshot.val();
            if (!data || !pc) return;

            if (data.offer && !data.answer && callerID !== 'creator' && state.value === 'call') {
              await createAnswer(data.offer, roomId);
            }

            if (data.answer && pc.signalingState === 'have-local-offer') {
              try {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
              } catch (e) {
                console.warn('Set remote desc error:', e);
              }
            }

            if (data.iceCandidates) {
              data.iceCandidates.forEach(async candidate => {
                if (candidate && pc) {
                  try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                  } catch (e) {
                    console.warn('ICE error:', e);
                  }
                }
              });
            }

            if (data.creatorLeftAt || data.participantLeftAt) {
              remoteStatus.value = 'disconnected';
            }
          });

          roomRef.child('creator').onDisconnect().update({ creatorLeftAt: firebase.database.ServerValue.TIMESTAMP });
          if (callerID !== 'creator') {
            roomRef.child('participant').onDisconnect().update({ participantLeftAt: firebase.database.ServerValue.TIMESTAMP });
          }
        }

        async function acceptCall() {
          state.value = 'call';
          remoteStatus.value = 'connecting';
          try {
            await createPeerConnection();
            await createOffer(roomID.value);
          } catch (e) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫.');
            hangup();
          }
        }

        function declineCall() {
          hangup();
        }

        async function createOffer(roomId) {
          if (!pc) await createPeerConnection();
          const offer = await pc.createOffer({ offerToReceiveAudio: 1, offerToReceiveVideo: 1 });
          await pc.setLocalDescription(offer);
          if (roomRef) await roomRef.update({ offer });
        }

        async function createAnswer(offer, roomId) {
          if (!pc) await createPeerConnection();
          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          if (roomRef) await roomRef.update({ answer });
          state.value = 'call';
          remoteStatus.value = 'connecting';
        }

        function toggleMute() {
          if (!localStream) return;
          const track = localStream.getAudioTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isMuted.value = !track.enabled;
          }
        }

        function toggleVideo() {
          if (!localStream) return;
          const track = localStream.getVideoTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isVideoOff.value = !track.enabled;
          }
        }

        function hangup() {
          [localStream, screenStream, remoteStream].forEach(stream => {
            if (stream) stream.getTracks().forEach(t => t.stop());
          });
          localStream = screenStream = remoteStream = null;

          if (pc) {
            pc.close();
            pc = null;
          }

          if (roomRef) {
            const key = callerID === 'creator' ? 'creatorLeftAt' : 'participantLeftAt';
            roomRef.update({ [key]: firebase.database.ServerValue.TIMESTAMP }).catch(() => {});
            roomRef.off();
            roomRef = null;
          }

          roomID.value = '';
          roomLink.value = '';
          remoteUsername.value = '';
          isScreenSharing.value = false;
          state.value = 'setup';
          window.history.pushState({}, '', window.location.pathname);
        }

        onMounted(async () => {
          if (!window.RTCPeerConnection) {
            alert('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Edge –∏–ª–∏ Safari.');
            return;
          }

          if (roomFromUrl && localStorage.getItem('mycall_username')) {
            username.value = localStorage.getItem('mycall_username');
            setTimeout(() => joinRoom(roomFromUrl), 300);
          } else {
            state.value = 'setup';
          }
        });

        watch(username, (val) => {
          if (val.trim()) localStorage.setItem('mycall_username', val.trim());
        });

        return {
          state,
          username,
          roomID,
          remoteUsername,
          remoteStatus,
          isMuted,
          isVideoOff,
          isScreenSharing,
          roomLink,
          copied,
          isMobile,
          createOrJoinRoom,
          joinRoom,
          acceptCall,
          declineCall,
          toggleMute,
          toggleVideo,
          toggleScreenShare,
          hangup,
          copyLink,
          installPWA,
          $route: { room: roomFromUrl }
        };
      }
    }).mount('#app');

    // Service Worker
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE = 'mycall-v4-metered';
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
        });
        self.addEventListener('fetch', e => {
          if (e.request.method !== 'GET') return;
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swURL).catch(console.warn);
    }
  </script>
</body>
</html>
