<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>MyCall ‚Äî –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ –∫–∞–∫ –≤ FaceTime</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0071e3">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230071e3%22>üìû</text></svg>">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Firebase -->
  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º SDK v9 (modular) –∫–∞–∫ –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º v8 (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root { --face-blue: #0071e3; }
    body {
      background: linear-gradient(135deg, #e0e0e5, #d0d4db);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0; height: 100vh; overflow: hidden;
    }
    .video-container {
      position: relative; width: 100%; height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    video {
      border-radius: 20px; background: #000; object-fit: cover;
    }
    #remoteVideo { 
        width: 100%; height: 100%; border-radius: 24px;
        /* –°–ø—Ä—è—Ç–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Ç–æ–∫–∞ */
        opacity: 0; transition: opacity 0.3s;
    }
    #remoteVideo.active { opacity: 1; }
    
    #localVideo {
      position: absolute; bottom: 20px; right: 20px;
      width: 180px; height: 135px; border: 3px solid white;
      border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .controls {
      position: absolute; bottom: 5vh; display: flex; gap: 16px;
      z-index: 11;
    }
    .btn-circle {
      width: 64px; height: 64px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: none;
    }
    .btn-green { background: #30d158; color: white; }
    .btn-red { background: #ff3b30; color: white; }
    .btn-gray { background: #545458; color: white; }
    .btn-orange { background: #ff9500; color: white; }
    .setup-card {
      background: white; border-radius: 24px; padding: 28px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-width: 500px; width: 90%;
    }
    .logo {
      font-size: 2.2rem; font-weight: 700;
      background: linear-gradient(90deg, #0071e3, #5ac8fa);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .status-bar {
      position: absolute; top: 20px; background: rgba(0,0,0,0.6);
      color: white; padding: 8px 20px; border-radius: 50px;
      font-weight: 500; backdrop-filter: blur(8px);
      min-width: 150px; text-align: center;
    }
  </style>
</head>
<body>

  <div id="app">
    <!-- Init -->
    <div v-if="state === 'init'" class="video-container">
      <div class="text-center">
        <h2 class="logo mb-3">MyCall</h2>
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</p>
      </div>
    </div>

    <!-- Setup -->
    <div v-else-if="state === 'setup'" class="video-container">
      <div class="setup-card">
        <h2 class="logo text-center mb-3">MyCall</h2>
        <p class="text-center text-muted mb-4">–ù–∞—á–Ω–∏—Ç–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞ —Å–µ–∫—É–Ω–¥—ã</p>

        <div class="mb-3">
          <input v-model="username" @keyup.enter="createOrJoinRoom"
            class="form-control form-control-lg" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)" maxlength="20">
        </div>

        <button @click="createOrJoinRoom" :disabled="!username.trim()"
          class="btn btn-primary btn-lg w-100 mb-3">
          <i class="bi bi-plus-circle me-2"></i> –°–æ–∑–¥–∞—Ç—å/–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
        </button>

        <!-- –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å –∫–æ–º–Ω–∞—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏—é –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è -->
        <div v-if="roomFromUrl" class="mt-3 p-3 bg-light rounded-3">
          <p class="mb-1"><small>–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –≤ –∫–æ–º–Ω–∞—Ç—É:</small></p>
          <p class="fw-bold text-primary mb-2">{{ roomFromUrl }}</p>
          <button @click="handleJoinFromUrl" :disabled="!username.trim()" class="btn btn-success w-100">
            <i class="bi bi-telephone-inbound me-2"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ {{ roomFromUrl }}
          </button>
          <p v-if="!username.trim()" class="text-danger mt-2 small">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.</p>
        </div>

        <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–º–Ω–∞—Ç—ã -->
        <div v-if="roomLink && state === 'setup' && !roomFromUrl" class="mt-4">
          <p class="small text-muted mb-2">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</p>
          <div class="input-group">
            <input :value="roomLink" class="form-control" readonly>
            <button class="btn btn-outline-primary" @click="copyLink">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <p v-if="copied" class="text-success mt-2 small">
            <i class="bi bi-check-circle-fill me-1"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
          </p>
        </div>
      </div>
    </div>

    <!-- Waiting (Creator) -->
    <div v-else-if="state === 'waiting'" class="video-container">
      <div class="status-bar bg-warning text-dark">
        <i class="bi bi-clock me-2"></i> –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞‚Ä¶
      </div>
      <h3 class="logo text-white mb-3">MyCall</h3>
      <p class="text-white">–í–∞—à–∞ –∫–æ–º–Ω–∞—Ç–∞: <span class="fw-bold">{{ roomID }}</span></p>
      
      <div class="mt-4 text-center">
        <p class="small text-white opacity-75 mb-2">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π:</p>
        <div class="input-group justify-content-center">
            <input :value="roomLink" class="form-control w-auto" style="max-width: 250px;" readonly>
            <button class="btn btn-outline-light" @click="copyLink">
              <i class="bi bi-clipboard"></i>
            </button>
        </div>
      </div>

      <button @click="hangup" class="btn btn-outline-light btn-sm mt-4">
        <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
      </button>
    </div>

    <!-- Incoming (Receiver) -->
    <div v-else-if="state === 'incoming'" class="video-container">
      <div class="status-bar">
        <i class="bi bi-telephone-incoming me-2"></i> –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
      </div>
      <div class="text-center text-white mt-4">
        <h4 class="logo">{{ remoteUsername || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' }}</h4>
        <p class="opacity-75">–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</p>
        <div class="mt-4 d-flex gap-3 justify-content-center">
          <button @click="declineCall" class="btn-circle btn-red">
            <i class="bi bi-telephone-x"></i>
          </button>
          <button @click="acceptCall" class="btn-circle btn-green">
            <i class="bi bi-telephone"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Call -->
    <div v-else-if="state === 'call'" class="video-container">
      <div class="status-bar" :class="isScreenSharing ? 'bg-orange' : 'bg-success'">
        <i :class="isScreenSharing ? 'bi bi-display' : 'bi bi-circle-fill me-2'"></i>
        <span>{{ isScreenSharing ? '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞' : remoteUsername ? remoteUsername : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫' }}</span>
      </div>

      <video id="remoteVideo" autoplay playsinline muted="false" class="active"></video>
      <!-- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞, video –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ –ø—É—Å—Ç—ã–º —á–µ—Ä–Ω—ã–º –±–ª–æ–∫–æ–º -->
      <video id="localVideo" autoplay playsinline muted></video>

      <div class="controls">
        <button @click="toggleMute" class="btn-circle btn-gray" :aria-pressed="isMuted">
          <i :class="isMuted ? 'bi bi-mic-mute-fill' : 'bi bi-mic-fill'"></i>
        </button>
        <button @click="toggleVideo" class="btn-circle btn-gray" :aria-pressed="isVideoOff">
          <i :class="isVideoOff ? 'bi bi-camera-video-off-fill' : 'bi bi-camera-video-fill'"></i>
        </button>
        <button v-if="!isMobile" @click="toggleScreenShare" class="btn-circle btn-orange" :aria-pressed="isScreenSharing">
          <i class="bi bi-display"></i>
        </button>
        <button @click="hangup" class="btn-circle btn-red">
          <i class="bi bi-telephone-x"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∫–ª—é—á–∏ –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", 
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
      messagingSenderId: "YOUR_MESSAGING_ID",
      appId: "YOUR_APP_ID"
    };

    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } catch (e) {
      console.error('‚ùå Firebase initialization error:', e);
      alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.');
    }
  </script>

  <script>
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
      setup() {
        const state = ref('init'); // init, setup, waiting, incoming, call
        const username = ref(localStorage.getItem('mycall_username') || '');
        const roomID = ref('');
        const remoteUsername = ref('');
        const roomLink = ref('');
        const copied = ref(false);
        const isMuted = ref(false);
        const isVideoOff = ref(false);
        const isScreenSharing = ref(false);
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –¥–µ–º–æ —ç–∫—Ä–∞–Ω–∞
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = ref(urlParams.get('room'));

        let localStream = null;
        let screenStream = null;
        let remoteStream = null;
        let pc = null;
        let roomRef = null;

        // –ù–∞–¥–µ–∂–Ω—ã–µ ICE —Å–µ—Ä–≤–µ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–ª–∏ –≤–∞—à–∏ TURN)
        const iceServers = [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          // –î–æ–±–∞–≤—å—Ç–µ TURN, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–±–∏–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∞–µ—Ä–≤–æ–ª—ã
        ];

        // --- WebRTC Helper Functions ---

        function setVideoSrc(videoId, stream) {
          const video = document.getElementById(videoId);
          if (video) {
            video.srcObject = stream;
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (–Ω—É–∂–Ω–æ –¥–ª—è remoteVideo)
            if (videoId === 'remoteVideo' && stream) {
                video.style.opacity = 1;
            }
          }
        }

        async function getMedia(useScreen = false) {
          if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
          }
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: useScreen ? false : { width: 1280, height: 720, facingMode: 'user' },
              audio: true
            });
            localStream = stream;
            setVideoSrc('localVideo', localStream);
            return stream;
          } catch (e) {
            console.error('Media access error:', e);
            alert('–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: ' + (e.name === 'NotAllowedError' ? '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω.' : e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'));
            throw e;
          }
        }

        function createPeerConnection() {
          pc = new RTCPeerConnection({ iceServers });

          // 1. ICE Candidates
          pc.onicecandidate = async (event) => {
            if (event.candidate && roomRef) {
              await roomRef.child('iceCandidates').push({ candidate: event.candidate.toJSON() });
            }
          };

          // 2. Remote Track (–ü–æ–ª—É—á–∞–µ–º –ø–æ—Ç–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞)
          pc.ontrack = (event) => {
            if (remoteStream) return; // –£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
            remoteStream = event.streams[0];
            setVideoSrc('remoteVideo', remoteStream);
          };
          
          // 3. Remote Stream Removal (–î–ª—è —Å–º–µ–Ω—ã –ø–æ—Ç–æ–∫–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)
          pc.onconnectionstatechange = () => {
            if (pc.connectionState === 'failed') {
              console.error("Connection failed.");
              hangup();
            }
            if (pc.connectionState === 'disconnected' || pc.connectionState === 'closed') {
                console.warn("Connection closed or disconnected.");
                // –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è"
            }
          };

          // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
          if (localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          }
        }

        // --- –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –õ–æ–≥–∏–∫–∞ ---

        async function createOrJoinRoom() {
          if (!username.value.trim()) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.');
            return;
          }
          localStorage.setItem('mycall_username', username.value.trim());

          if (roomFromUrl.value) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–Ω–∞—Ç–µ
            roomID.value = roomFromUrl.value;
            roomLink.value = `${window.location.origin}?room=${roomFromUrl.value}`;
            state.value = 'incoming'; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é Offer
          } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
            const id = generateRoomID();
            roomID.value = id;
            roomLink.value = `${window.location.origin}?room=${id}`;
            state.value = 'waiting'; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é Caller (Offer)
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ DB, –Ω–æ –º–µ–¥–∏–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ
            roomRef = db.ref(`rooms/${id}`);
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–Ω–∞—Ç–µ (–¥–ª—è Incoming Call)
            listenForSignaling();
          }
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ
        function handleJoinFromUrl() {
            if (!username.value.trim()) {
                 alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.');
                 return;
            }
            localStorage.setItem('mycall_username', username.value.trim());
            roomID.value = roomFromUrl.value;
            roomLink.value = `${window.location.origin}?room=${roomFromUrl.value}`;
            state.value = 'incoming';
            roomRef = db.ref(`rooms/${roomID.value}`);
            listenForSignaling(); // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É
        }


        async function acceptCall() {
          try {
            // 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–µ–¥–∏–∞ (–∫–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω)
            await getMedia(); 
            // 2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
            state.value = 'call';
            // 3. –°–æ–∑–¥–∞–µ–º PeerConnection
            createPeerConnection();
            // 4. –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º Offer (Caller)
            await createOffer();
            // 5. –°–ª—É—à–∞–µ–º –û—Ç–≤–µ—Ç (Answer)
            listenForAnswer();
            // 6. –°–ª—É—à–∞–µ–º ICE Candidates –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            listenForCandidates();

          } catch (e) {
            console.error("Failed to accept call:", e);
            hangup();
          }
        }
        
        async function createOffer() {
            const offer = await pc.createOffer({ offerToReceiveVideo: 1, offerToReceiveAudio: 1 });
            await pc.setLocalDescription(offer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Offer –≤ –∫–æ–º–Ω–∞—Ç—É
            await roomRef.child('offers').push({
                sdp: pc.localDescription,
                username: username.value.trim()
            });
        }
        
        // --- –õ–æ–≥–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞ (Database Listeners) ---
        
        function listenForSignaling() {
            if (!roomRef) return;
            
            // 1. –°–ª—É—à–∞–µ–º, –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Offer
            roomRef.child('offers').on('child_added', (snapshot) => {
                const offerData = snapshot.val();
                
                if (snapshot.key === callerID) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π offer
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                remoteUsername.value = offerData.username || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
                callerID = snapshot.key; // –≠—Ç–æ ID —Ç–æ–≥–æ, –∫—Ç–æ —Å–æ–∑–¥–∞–ª –∫–æ–º–Ω–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª offer

                if (state.value === 'incoming') {
                    // –ú—ã —Å–ª—É—à–∞–µ–º –∫–æ–º–Ω–∞—Ç—É, –∏ –ø—Ä–∏—à–µ–ª Offer (–Ω–∞—Å –∑–æ–≤—É—Ç)
                    pc.setRemoteDescription(new RTCSessionDescription(offerData.sdp));
                    // –ñ–¥–µ–º, –ø–æ–∫–∞ –ø—Ä–∏–º—É—Ç –∑–≤–æ–Ω–æ–∫, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å Answer
                }
            });
            
            // 2. –°–ª—É—à–∞–µ–º ICE Candidates –æ—Ç —É–¥–∞–ª–µ–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
            roomRef.child('iceCandidates').on('child_added', (snapshot) => {
                if (!pc) return;
                const candidateData = snapshot.val();
                if (candidateData && candidateData.candidate) {
                    try {
                         pc.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                    } catch (e) {
                        console.error('Error adding received ICE candidate:', e);
                    }
                }
            });
        }
        
        function listenForAnswer() {
            if (!roomRef) return;
            
            // –°–ª—É—à–∞–µ–º –û—Ç–≤–µ—Ç (Answer) –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–Ω—è–ª –∑–≤–æ–Ω–æ–∫
            roomRef.child('answers').on('child_added', async (snapshot) => {
                if (snapshot.key !== callerID) return; // –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –ø–æ–¥ —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º, —á—Ç–æ –∏ Offer
                
                const answerData = snapshot.val();
                
                if (pc && answerData.sdp) {
                    await pc.setRemoteDescription(new RTCSessionDescription(answerData.sdp));
                    
                    // –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Answer, –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å ICE Candidates –æ—Ç –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
                    // (–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã —Å–ª—É—à–∞–µ–º –∏—Ö –≤ `listenForSignaling`, –Ω–æ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                    
                    // –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
                    // –í –Ω–∞—à–µ–π —Å—Ö–µ–º–µ, –º—ã —É–∂–µ —Å–ª—É—à–∞–µ–º `iceCandidates`, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
                    state.value = 'call';
                }
            });
        }


        async function handleRemoteHangup(snapshot) {
            // –≠—Ç–æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –º—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É ('waiting')
            if (snapshot.key === 'hangup') {
                if (state.value === 'waiting') {
                    alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                    hangup();
                }
            }
        }
        
        function declineCall() { hangup(); }
        
        async function hangup() {
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–æ–≤
          [localStream, screenStream, remoteStream].forEach(s => {
            if (s) s.getTracks().forEach(t => t.stop());
          });
          // –ó–∞–∫—Ä—ã—Ç–∏–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          if (pc) pc.close();
          // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π Firebase
          if (roomRef) {
            // –£–≤–µ–¥–æ–º–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ)
            if (state.value === 'call' || state.value === 'waiting') {
                roomRef.child('hangup').set(true);
            }
            roomRef.off();
          }

          // –°–±—Ä–æ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          pc = localStream = screenStream = remoteStream = roomRef = null;
          roomID.value = '';
          remoteUsername.value = '';
          isScreenSharing.value = false;
          
          // –í–æ–∑–≤—Ä–∞—Ç –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          window.history.replaceState({}, document.title, window.location.pathname);
          state.value = 'setup';
        }

        // --- UI Controls ---

        function toggleMute() {
          const track = localStream?.getAudioTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isMuted.value = !track.enabled;
          }
        }

        function toggleVideo() {
          const track = localStream?.getVideoTracks()[0];
          if (track) {
            track.enabled = !track.enabled;
            isVideoOff.value = !track.enabled;
          }
        }

        async function toggleScreenShare() {
          if (!localStream) return;
          
          if (isScreenSharing.value) {
            // –í—ã–∫–ª—é—á–∞–µ–º —à–∞—Ä–∏–Ω–≥, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É
            screenStream?.getTracks().forEach(t => t.stop());
            screenStream = null;
            isScreenSharing.value = false;
            
            // –ó–∞–º–µ–Ω—è–µ–º —Ç—Ä–µ–∫ –Ω–∞ —Ç—Ä–µ–∫ —Å –∫–∞–º–µ—Ä—ã
            const cameraTrack = localStream.getVideoTracks()[0];
            const sender = pc?.getSenders().find(s => s.track?.kind === 'video');
            if (sender && cameraTrack) {
                 sender.replaceTrack(cameraTrack);
            }
            setVideoSrc('localVideo', localStream);
          } else {
            // –í–∫–ª—é—á–∞–µ–º —à–∞—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞
            try {
              screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: 'motion', width: { ideal: 1920 }, frameRate: 30 },
                audio: false
              });
              isScreenSharing.value = true;
              
              // –ó–∞–º–µ–Ω—è–µ–º —Ç—Ä–µ–∫ –Ω–∞ —Ç—Ä–µ–∫ —Å —ç–∫—Ä–∞–Ω–∞
              const screenTrack = screenStream.getVideoTracks()[0];
              const sender = pc?.getSenders().find(s => s.track?.kind === 'video');
              if (sender && screenTrack) {
                 sender.replaceTrack(screenTrack);
              } else if (pc) {
                  pc.addTrack(screenTrack, screenStream);
              }
              setVideoSrc('localVideo', screenStream);

            } catch (e) {
              if (e.name !== 'NotAllowedError') {
                console.error("Screen share error:", e);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –±—Ä–∞—É–∑–µ—Ä —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
              }
              // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ—Ç–º–µ–Ω—è–µ–º —à–∞—Ä–∏–Ω–≥
              isScreenSharing.value = false; 
            }
          }
        }

        function copyLink() {
          if (!roomLink.value) return;
          navigator.clipboard.writeText(roomLink.value).then(() => {
            copied.value = true;
            setTimeout(() => copied.value = false, 2000);
          });
        }
        
        function generateRoomID() {
          return Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        onMounted(() => {
          if (!window.RTCPeerConnection) {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.');
            state.value = 'setup'; // –û—Å—Ç–∞–µ–º—Å—è –Ω–∞ setup, –Ω–æ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–≤–æ–Ω–∫–∞
            return;
          }
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–Ω–∞—Ç–∞ –≤ URL, –Ω–æ –º—ã –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –µ–µ –≤ createOrJoinRoom (—Ç.–µ. –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
          if (roomFromUrl.value && !pc) {
              state.value = 'setup'; // –ñ–¥–µ–º –∫–ª–∏–∫–∞ –Ω–∞ "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"
          } else {
              state.value = 'setup';
          }
          
          // –ï—Å–ª–∏ –º—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É –∏ –ø–µ—Ä–µ—à–ª–∏ –≤ waiting, –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å hangup
          watch(state, (newState) => {
              if (newState === 'waiting' && roomRef) {
                  roomRef.child('hangup').on('value', handleRemoteHangup);
              }
          }, { immediate: true });
          
          // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'call', –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –≤—Å–µ—Ö ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ 
          // —Å –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Offer/Answer.
          watch(state, (newState) => {
              if (newState === 'call' && pc) {
                  // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä ICE, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
                  pc.onicecandidate = (event) => {
                    if (event.candidate && roomRef) {
                      roomRef.child('iceCandidates').push({ candidate: event.candidate.toJSON() });
                    }
                  };
                  // –ï—Å–ª–∏ –º—ã Caller, –º—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ offer. –ï—Å–ª–∏ –º—ã Receiver, –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ Answer.
                  // –¢–µ–ø–µ—Ä—å –≥–ª–∞–≤–Ω–æ–µ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã.
              }
          });
          
        });

        return {
          state, username, roomID, remoteUsername, roomLink, copied,
          isMuted, isVideoOff, isScreenSharing, isMobile,
          roomFromUrl,
          createOrJoinRoom, handleJoinFromUrl, acceptCall, declineCall,
          toggleMute, toggleVideo, toggleScreenShare, hangup, copyLink
        };
      }
    }).mount('#app');

    // Service Worker (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª sw.js)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => console.log('SW registered:', registration))
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
